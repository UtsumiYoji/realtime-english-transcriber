# 要件定義書: リアルタイム英語文字起こし＆翻訳アプリ

## 1. プロジェクト概要

### プロジェクト名
**Realtime English Transcriber** (仮称)

### 目的
業務で発生する英語音声（打ち合わせ、教育ビデオ教材等）をリアルタイムで文字起こしし、日本語翻訳を提供することで、英語を第二言語とするユーザーの業務効率を向上させる。

### 対象ユーザー
- 英語話者だが日本語が第一言語のエンジニア
- 個人利用（シングルユーザー）

---

## 2. 機能要件

### FR-01: 音声ソース選択
- **概要:** ユーザーがキャプチャ対象の音声デバイスを選択できる
- **詳細:**
  - Windows のオーディオデバイス一覧（WASAPI）を取得・表示する
  - ループバックデバイス（スピーカー出力のキャプチャ）に対応する
  - 仮想オーディオケーブル（VB-Audio VB-CABLE 等）を経由したアプリ別音声分離に対応する
  - デバイス選択は GUI の Combobox で行う
- **受け入れ基準:**
  - 利用可能なオーディオデバイスが一覧表示される
  - 選択したデバイスからの音声キャプチャが開始できる
  - デバイスが切断された場合にエラーが適切に表示される

### FR-02: リアルタイム英語音声文字起こし
- **概要:** キャプチャした英語音声をテキストに変換する
- **詳細:**
  - `faster-whisper` (CTranslate2 ベース) を使用
  - 英語専用モデル (`base.en`) を INT8 量子化で CPU 推論
  - Silero VAD で音声区間を検出し、発話単位で文字起こし
  - 30 秒超の連続発話は強制的にフラッシュして処理
  - タイムスタンプ付きで結果を表示
- **受け入れ基準:**
  - 英語音声がテキストとして表示される
  - 発話終了から 2〜7 秒以内にテキストが表示される
  - 無音時に誤ったテキストが生成されない（VAD によるフィルタ）

### FR-03: 日本語翻訳
- **概要:** 文字起こしされた英語テキストを日本語に翻訳する
- **詳細:**
  - DeepL Free API を使用
  - 翻訳の ON/OFF をチェックボックスで切り替え可能
  - API キーは設定ファイル (`config.yaml`) または環境変数から読み込み
  - 同一テキストの翻訳結果をキャッシュして API 呼び出しを削減
  - API エラー時のリトライ処理（最大 3 回、指数バックオフ）
- **受け入れ基準:**
  - 英語テキストの下に日本語訳が表示される
  - 翻訳の ON/OFF 切り替えが即座に反映される
  - API キー未設定時に適切なエラーメッセージが表示される

### FR-04: テキスト表示
- **概要:** 文字起こし・翻訳結果を GUI 上にリアルタイム表示する
- **詳細:**
  - タイムスタンプ付きのフォーマット: `[HH:MM:SS] EN: ... / JA: ...`
  - スクロール可能なテキスト表示エリア
  - 新しいテキストが追加されたら自動スクロール
  - テキスト選択・コピーが可能
- **受け入れ基準:**
  - テキストがタイムスタンプ付きで時系列順に表示される
  - 自動スクロールが機能する
  - テキストの選択・クリップボードコピーが可能

### FR-05: ファイル保存
- **概要:** 文字起こし・翻訳結果をファイルに保存する
- **詳細:**
  - 「名前を付けて保存」ダイアログで `.txt` ファイルとして保存
  - 保存フォーマット:
    ```
    [HH:MM:SS] EN: Hello, how are you?
    [HH:MM:SS] JA: こんにちは、お元気ですか？
    ```
  - セッション中のリアルタイム自動保存オプション（追記モード）
- **受け入れ基準:**
  - 「保存」ボタンで現在のトランスクリプトがファイルに保存される
  - 保存されたファイルが UTF-8 エンコーディングで正しく読める
  - 自動保存有効時、新しいテキストがリアルタイムでファイルに追記される

### FR-06: 設定管理
- **概要:** アプリの各種設定を外部ファイルで管理する
- **詳細:**
  - `config.yaml` で以下を設定可能:
    - DeepL API キー
    - Whisper モデルサイズ (tiny.en / base.en / small.en)
    - 翻訳 ON/OFF デフォルト
    - 自動保存先パス
    - デフォルトオーディオデバイス
  - 環境変数 `DEEPL_API_KEY` でも API キーを設定可能
  - 設定ファイルが存在しない場合はデフォルト値で自動生成
- **受け入れ基準:**
  - 設定ファイルの値がアプリに反映される
  - 設定ファイル不在時にデフォルト設定で起動する
  - 不正な設定値に対してエラーメッセージが表示される

### FR-07: 録音制御
- **概要:** 音声キャプチャの開始・停止を制御する
- **詳細:**
  - 「開始」「停止」ボタンで録音を制御
  - ステータスバーに現在の状態（録音中 / 停止中）を表示
- **受け入れ基準:**
  - 「開始」で音声キャプチャが始まり、「停止」で終了する
  - ステータスが正しく表示される

---

## 3. 非機能要件

### NFR-01: パフォーマンス
- 発話終了から文字起こしテキスト表示まで: **7 秒以内**（目標 5 秒以内）
- 翻訳を含むエンドツーエンドレイテンシ: **10 秒以内**（目標 7 秒以内）
- GUI がフリーズしないこと（バックグラウンドスレッドで重い処理を実行）

### NFR-02: リソース使用量
- メモリ使用量: 1GB 以下（Whisper モデルロード後の定常状態）
- CPU 使用率: 音声処理中でもシステムの応答性を維持

### NFR-03: 信頼性
- 長時間（数時間）の連続使用に耐えること
- メモリリークがないこと
- ネットワークエラー（翻訳 API）時にアプリがクラッシュしないこと

### NFR-04: 可用性
- 個人利用のためこだわった UI/UX は不要
- ただし基本的なユーザビリティ（わかりやすいボタン配置、ステータス表示）は確保する

### NFR-05: セキュリティ
- 個人利用、ローカル実行のためセキュリティ要件は最小限
- API キーは設定ファイルまたは環境変数で管理（ハードコードしない）

### NFR-06: 保守性
- モジュール分割された構成（音声キャプチャ / VAD / STT / 翻訳 / GUI）
- 各モジュールが独立してテスト可能

---

## 4. 技術選定

| コンポーネント | 選定技術 | 選定理由 |
|---|---|---|
| 言語 | Python 3.10+ | ユーザーがPythonエンジニアでコードレビュー可能。AI/音声系ライブラリが豊富 |
| GUI | Tkinter | Python 標準ライブラリ。追加依存なし。個人ツールには十分 |
| 音声キャプチャ | sounddevice | PortAudio ラッパー。WASAPI 対応。軽量 |
| 音声キャプチャ (FB) | PyAudioWPatch | WASAPI ループバックの確実なサポート |
| デバイス列挙 | pycaw | Windows Core Audio API ラッパー。アプリ別音声セッション情報取得 |
| 音声区間検出 | Silero VAD | 高精度 VAD。Whisper の無音幻聴を確実に防止 |
| 音声認識 | faster-whisper | CTranslate2 ベースで CPU 推論が高速。INT8 量子化対応 |
| 翻訳 | DeepL Free API (deepl SDK) | EN→JA 翻訳品質が最良。月 50 万字無料 |
| リサンプリング | numpy + scipy | 48kHz→16kHz ダウンサンプリング |
| 設定管理 | PyYAML | YAML 形式の設定ファイル読み書き |

---

## 5. 制約事項

1. **Windows 専用:** WASAPI ループバックは Windows のみ対応
2. **NVIDIA GPU なし:** CPU 推論のため、Whisper は base.en 以下のモデルサイズに制限
3. **DeepL Free API のクレジットカード登録:** 無料プランでもクレジットカード登録が必要（課金はされない）
4. **DeepL Free API の月間制限:** 50 万字/月 ≒ 約 11 時間/月の連続文字起こし
5. **アプリ別音声分離には仮想オーディオケーブルが必要:** Windows API の制約により、直接的なアプリ別キャプチャは不可
6. **エンドツーエンドレイテンシ 2〜7 秒:** 商用ストリーミング ASR のようなリアルタイム感は得られない
7. **PyTorch 依存:** Silero VAD が PyTorch を必要とするため、環境サイズが大きくなる（約 2GB）
8. **faster-whisper は AVX2 命令セット対応 CPU が必要:** 2015 年以降の CPU なら基本対応

---

## 6. 用語集

| 用語 | 説明 |
|---|---|
| WASAPI | Windows Audio Session API。Windows の低レベルオーディオ API |
| Loopback | スピーカー出力をそのままキャプチャする仕組み |
| VAD | Voice Activity Detection（音声区間検出）|
| STT | Speech-to-Text（音声認識・文字起こし）|
| INT8 量子化 | モデルの重みを 8bit 整数に変換し推論を高速化する手法 |
| CTranslate2 | OpenNMT が開発した高速推論エンジン |
| faster-whisper | CTranslate2 ベースの Whisper 実装。CPU/GPU 両対応 |
| VB-CABLE | VB-Audio 社の無料仮想オーディオケーブル |

---

## 改訂履歴

| 日付 | バージョン | 変更内容 |
|---|---|---|
| 2026-02-17 | 1.0 | 初版作成 |
